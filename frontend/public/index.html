<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CampusFlow - 学校管理システム</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50">
    <!-- ナビゲーション -->
    <nav class="bg-white shadow hidden" id="main-nav">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-bold text-blue-600">🎓 CampusFlow</h1>
                    <div class="ml-6 flex space-x-8">
                        <a href="#" class="nav-link border-b-2 border-blue-500 text-gray-900 inline-flex items-center px-1 pt-1 text-sm font-medium" data-tab="dashboard">
                            ダッシュボード
                        </a>
                        <a href="#" class="nav-link border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium" data-tab="assignments">
                            課題
                        </a>
                        <a href="#" class="nav-link border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium" data-tab="events">
                            イベント
                        </a>
                        <a href="#" class="nav-link border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium" data-tab="streams">
                            ストリーム
                        </a>
                        <a href="#" class="nav-link border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium" data-tab="lostItems">
                            忘れ物掲示板
                        </a>
                        <a href="#" class="nav-link border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium" data-tab="profile">
                            プロフィール
                        </a>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-700" id="user-name">読み込み中...</span>
                    <span class="text-xs px-2 py-1 bg-green-100 text-green-800 rounded-full" id="user-role">
                        学生
                    </span>
                    <button 
                        onclick="logout()" 
                        class="text-sm text-gray-500 hover:text-gray-700 px-3 py-1 rounded border border-gray-300 hover:bg-gray-50"
                    >
                        ログアウト
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- ログインページ -->
    <div id="login-page" class="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8">
            <div>
                <div class="mx-auto h-12 w-12 text-4xl text-center">🎓</div>
                <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
                    CampusFlow にログイン
                </h2>
                <p class="mt-2 text-center text-sm text-gray-600">
                    学校管理システムにアクセスするには<br>
                    Googleアカウントでログインしてください
                </p>
            </div>
            <div>
                <button 
                    onclick="loginWithGoogle()" 
                    class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors"
                >
                    <span class="absolute left-0 inset-y-0 flex items-center pl-3">
                        <svg class="h-5 w-5" viewBox="0 0 24 24">
                            <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                            <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                            <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                            <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                    </span>
                    Google でログイン
                </button>
                
                <!-- Super Admin ログインボタン -->
                <div class="mt-4 pt-4 border-t border-gray-200">
                    <p class="text-center text-xs text-gray-500 mb-3">管理者用</p>
                    <button 
                        onclick="loginAsSuperAdmin()" 
                        class="group relative w-full flex justify-center py-2 px-4 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-gray-50 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors"
                    >
                        <span class="absolute left-0 inset-y-0 flex items-center pl-3">
                            <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z" clip-rule="evenodd" />
                            </svg>
                        </span>
                        Super Admin でログイン
                    </button>
                </div>
                
                <div id="login-loading" class="hidden mt-4 text-center">
                    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mx-auto"></div>
                    <p class="mt-2 text-sm text-gray-500">認証中...</p>
                </div>
                
                <div id="login-error" class="hidden mt-4 bg-red-50 border border-red-200 rounded-md p-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-red-800">
                                ログインに失敗しました
                            </h3>
                            <div class="mt-2 text-sm text-red-700" id="login-error-message">
                                もう一度お試しください
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- メインコンテンツ -->
    <main class="py-10 hidden" id="main-content">
        <div class="max-w-7xl mx-auto sm:px-6 lg:px-8">
            <div class="px-4 py-6 sm:px-0">
                <!-- ダッシュボード -->
                <div id="dashboard" class="page-content">
                    <div class="mb-8">
                        <h1 class="text-3xl font-bold text-gray-900">
                            おかえりなさい、<span id="welcome-name">さん</span>！
                        </h1>
                        <p class="mt-2 text-gray-600">
                            今日の学習状況をチェックしましょう
                        </p>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- 課題セクション -->
                        <div class="bg-white overflow-hidden shadow rounded-lg">
                            <div class="p-6">
                                <div class="flex items-center justify-between mb-4">
                                    <h2 class="text-lg font-medium text-gray-900">
                                        📝 今後の課題
                                    </h2>
                                    <a href="#" onclick="showAssignments()" class="text-sm text-blue-600 hover:text-blue-500">
                                        すべて表示 →
                                    </a>
                                </div>
                                
                                <div id="dashboard-assignments" class="space-y-4">
                                    <div class="text-center py-8">
                                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                                        <p class="mt-2 text-gray-500">読み込み中...</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- イベントセクション -->
                        <div class="bg-white overflow-hidden shadow rounded-lg">
                            <div class="p-6">
                                <div class="flex items-center justify-between mb-4">
                                    <h2 class="text-lg font-medium text-gray-900">
                                        📅 今後のイベント
                                    </h2>
                                    <a href="#" onclick="showEvents()" class="text-sm text-blue-600 hover:text-blue-500">
                                        すべて表示 →
                                    </a>
                                </div>
                                
                                <div id="dashboard-events" class="space-y-4">
                                    <div class="text-center py-8">
                                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                                        <p class="mt-2 text-gray-500">読み込み中...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 統計情報 -->
                    <div class="mt-8 grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div class="bg-white overflow-hidden shadow rounded-lg">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white text-lg">
                                            📝
                                        </div>
                                    </div>
                                    <div class="ml-5 w-0 flex-1">
                                        <dt class="text-sm font-medium text-gray-500 truncate">
                                            合計課題数
                                        </dt>
                                        <dd class="text-lg font-medium text-gray-900" id="total-assignments">
                                            0
                                        </dd>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white overflow-hidden shadow rounded-lg">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white text-lg">
                                            📅
                                        </div>
                                    </div>
                                    <div class="ml-5 w-0 flex-1">
                                        <dt class="text-sm font-medium text-gray-500 truncate">
                                            イベント数
                                        </dt>
                                        <dd class="text-lg font-medium text-gray-900" id="total-events">
                                            0
                                        </dd>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white overflow-hidden shadow rounded-lg">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-purple-500 rounded-full flex items-center justify-center text-white text-lg">
                                            👤
                                        </div>
                                    </div>
                                    <div class="ml-5 w-0 flex-1">
                                        <dt class="text-sm font-medium text-gray-500 truncate">
                                            あなたの役割
                                        </dt>
                                        <dd class="text-lg font-medium text-gray-900" id="user-role-display">
                                            学生
                                        </dd>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 課題ページ -->
                <div id="assignments" class="page-content hidden">
                    <div class="mb-8">
                        <h1 class="text-3xl font-bold text-gray-900">📝 課題管理</h1>
                        <p class="mt-2 text-gray-600">
                            すべての課題を一覧で管理できます
                        </p>
                    </div>

                    <div id="assignments-content">
                        <div class="text-center py-12">
                            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
                            <p class="mt-4 text-gray-500">課題を読み込み中...</p>
                        </div>
                    </div>
                </div>

                <!-- イベントページ -->
                <div id="events" class="page-content hidden">
                    <div class="mb-8">
                        <h1 class="text-3xl font-bold text-gray-900">📅 イベント管理</h1>
                        <p class="mt-2 text-gray-600">
                            学校行事やイベントをカレンダー形式で管理できます
                        </p>
                    </div>

                    <div id="events-content">
                        <div class="text-center py-12">
                            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
                            <p class="mt-4 text-gray-500">イベントを読み込み中...</p>
                        </div>
                    </div>
                </div>

                <!-- ストリームページ -->
                <div id="streams" class="page-content hidden">
                    <div class="mb-8">
                        <div class="flex justify-between items-start">
                            <div>
                                <h1 class="text-3xl font-bold text-gray-900">💬 クラス・教科ストリーム</h1>
                                <p class="mt-2 text-gray-600">
                                    クラス・教科ごとのお知らせや投稿を確認できます
                                </p>
                            </div>
                            <div class="flex gap-3">
                                <!-- 管理者機能ボタン（super_admin, admin, teacherのみ表示） -->
                                <div id="stream-admin-controls" class="hidden flex gap-2">
                                    <button 
                                        onclick="startBrainstorming()" 
                                        class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 focus:ring-2 focus:ring-purple-500 transition-colors text-sm"
                                    >
                                        🧠 ブレスト開始
                                    </button>
                                    <button 
                                        onclick="showCreateStreamModal()" 
                                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 transition-colors text-sm"
                                    >
                                        + クラス作成
                                    </button>
                                    <button 
                                        onclick="showInviteModal()" 
                                        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 focus:ring-2 focus:ring-green-500 transition-colors text-sm"
                                    >
                                        ユーザー招待
                                    </button>
                                </div>
                                <div class="relative">
                                    <input 
                                        type="text" 
                                        id="stream-search" 
                                        placeholder="全ストリーム検索..." 
                                        class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 w-64"
                                        oninput="searchAnnouncements()"
                                    >
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ストリーム一覧 -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- ストリームリスト -->
                        <div class="lg:col-span-1">
                            <div class="bg-white rounded-lg shadow p-6">
                                <h3 class="text-lg font-semibold text-gray-900 mb-4">参加中のストリーム</h3>
                                <div id="streams-list" class="space-y-3">
                                    <div class="text-center py-8">
                                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                                        <p class="mt-2 text-gray-500">読み込み中...</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 選択されたストリームのお知らせ -->
                        <div class="lg:col-span-2">
                            <div class="bg-white rounded-lg shadow p-6">
                                <!-- ストリーム固有の権限昇格UI -->
                                <div id="stream-elevation-section" class="hidden mb-6 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                    <div class="flex items-start">
                                        <div class="flex-shrink-0">
                                            <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                            </svg>
                                        </div>
                                        <div class="ml-3 flex-1">
                                            <h3 class="text-sm font-medium text-yellow-800">
                                                このストリームで投稿権限を取得
                                            </h3>
                                            <div class="mt-2 text-sm text-yellow-700">
                                                <p>ストリーム管理者コードを入力して、<span id="selected-stream-name">このストリーム</span>での投稿権限を取得できます。</p>
                                            </div>
                                            <div class="mt-3 flex gap-3">
                                                <input 
                                                    type="password" 
                                                    id="stream-specific-code" 
                                                    placeholder="ストリーム管理者コード"
                                                    class="flex-1 px-3 py-2 text-sm border border-yellow-300 rounded-md focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500"
                                                >
                                                <button 
                                                    onclick="elevateForCurrentStream()" 
                                                    class="px-4 py-2 text-sm bg-yellow-600 text-white rounded-md hover:bg-yellow-700 focus:ring-2 focus:ring-yellow-500 focus:ring-offset-2"
                                                >
                                                    権限取得
                                                </button>
                                            </div>
                                            <div id="stream-elevation-result" class="hidden mt-3"></div>
                                        </div>
                                    </div>
                                </div>

                                <div id="stream-announcements">
                                    <div class="text-center py-12">
                                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10m0 0V6a2 2 0 00-2-2H9a2 2 0 00-2 2v2m0 0v10a2 2 0 002 2h10a2 2 0 002-2V8M9 12h6"></path>
                                        </svg>
                                        <h3 class="mt-4 text-lg font-medium text-gray-900">ストリームを選択してください</h3>
                                        <p class="mt-2 text-gray-500">左側からストリームを選択すると、お知らせが表示されます</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- プロフィールページ -->
                <div id="profile" class="page-content hidden">
                    <div class="mb-8">
                        <h1 class="text-3xl font-bold text-gray-900">👤 プロフィール</h1>
                        <p class="mt-2 text-gray-600">
                            アカウント情報の確認とストリーム管理者権限の申請ができます
                        </p>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- プロフィール情報 -->
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="text-lg font-semibold text-gray-900">アカウント情報</h2>
                                <button 
                                    id="edit-profile-btn" 
                                    onclick="toggleProfileEdit()" 
                                    class="text-blue-600 hover:text-blue-800 text-sm font-medium"
                                >
                                    編集
                                </button>
                            </div>
                            
                            <div id="profile-info" class="space-y-4">
                                <div class="text-center py-8">
                                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                                    <p class="mt-2 text-gray-500">読み込み中...</p>
                                </div>
                            </div>

                            <!-- 編集フォーム（初期状態では非表示） -->
                            <div id="profile-edit-form" class="hidden space-y-4 mt-6 pt-6 border-t border-gray-200">
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <label for="edit-name" class="block text-sm font-medium text-gray-700 mb-2">名前</label>
                                        <input 
                                            type="text" 
                                            id="edit-name" 
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                        >
                                    </div>
                                    <div>
                                        <label for="edit-class-name" class="block text-sm font-medium text-gray-700 mb-2">クラス</label>
                                        <input 
                                            type="text" 
                                            id="edit-class-name" 
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                            placeholder="例: 1年A組"
                                        >
                                    </div>
                                    <div>
                                        <label for="edit-grade" class="block text-sm font-medium text-gray-700 mb-2">学年</label>
                                        <select 
                                            id="edit-grade" 
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                        >
                                            <option value="">学年を選択</option>
                                            <option value="1">1年</option>
                                            <option value="2">2年</option>
                                            <option value="3">3年</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="edit-student-number" class="block text-sm font-medium text-gray-700 mb-2">学籍番号</label>
                                        <input 
                                            type="text" 
                                            id="edit-student-number" 
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                            placeholder="例: 2024001"
                                        >
                                    </div>
                                </div>
                                
                                <div class="flex gap-3 pt-4">
                                    <button 
                                        onclick="saveProfileChanges()" 
                                        class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors"
                                    >
                                        保存
                                    </button>
                                    <button 
                                        onclick="cancelProfileEdit()" 
                                        class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400 focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-colors"
                                    >
                                        キャンセル
                                    </button>
                                </div>
                                
                                <!-- 保存結果メッセージ -->
                                <div id="profile-save-result" class="hidden"></div>
                            </div>
                        </div>

                        <!-- ストリーム管理者コード入力 -->
                        <div class="bg-white rounded-lg shadow p-6">
                            <h2 class="text-lg font-semibold text-gray-900 mb-4">ストリーム管理者権限</h2>
                            <p class="text-gray-600 mb-2">
                                ストリーム管理者コードを入力して、投稿権限を取得できます。
                            </p>
                            <div class="bg-blue-50 border-l-4 border-blue-400 p-3 mb-4">
                                <div class="flex">
                                    <div class="flex-shrink-0">
                                        <svg class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                                        </svg>
                                    </div>
                                    <div class="ml-3">
                                        <p class="text-sm text-blue-700 mb-2">
                                            <strong>全ストリーム対象コード：</strong> <code class="bg-blue-100 px-1 rounded">STREAM_ADMIN_123</code>
                                        </p>
                                        <p class="text-sm text-blue-700 mb-1">
                                            <strong>ストリーム固有コード：</strong>
                                        </p>
                                        <ul class="text-xs text-blue-600 space-y-1">
                                            <li>• 1年A組: <code class="bg-blue-100 px-1 rounded">CLASS_1A_ADMIN</code></li>
                                            <li>• 数学科: <code class="bg-blue-100 px-1 rounded">MATH_ADMIN_456</code></li>
                                            <li>• 全校: <code class="bg-blue-100 px-1 rounded">SCHOOL_ADMIN_789</code></li>
                                            <li>• 英語科: <code class="bg-blue-100 px-1 rounded">ENGLISH_ADMIN_321</code></li>
                                            <li>• 生徒会: <code class="bg-blue-100 px-1 rounded">STUDENT_COUNCIL_654</code></li>
                                        </ul>
                                        <p class="text-xs text-blue-600 mt-2">
                                            ※ ストリーム固有コードは該当ストリームでのみ有効です
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="space-y-4">
                                <div>
                                    <label for="stream-admin-code" class="block text-sm font-medium text-gray-700 mb-2">
                                        ストリーム管理者コード
                                    </label>
                                    <input 
                                        type="password" 
                                        id="stream-admin-code" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                        placeholder="管理者から提供されたコードを入力"
                                    >
                                </div>
                                
                                <button 
                                    id="elevate-btn"
                                    onclick="elevateToStreamAdmin()" 
                                    class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors"
                                >
                                    権限を申請
                                </button>
                                
                                <!-- 成功・エラーメッセージ -->
                                <div id="elevation-result" class="hidden"></div>
                            </div>
                        </div>
                    </div>

                    <!-- ストリームメンバーシップ情報 -->
                    <div class="mt-8 bg-white rounded-lg shadow p-6">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4">参加中のストリーム</h2>
                        <div id="stream-memberships" class="space-y-3">
                            <div class="text-center py-8">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                                <p class="mt-2 text-gray-500">読み込み中...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- 忘れ物掲示板ページ -->
        <div id="lostItems" class="page-content hidden">
            <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
                <div class="px-4 py-6 sm:px-0">
                    <div class="mb-8">
                        <div class="flex justify-between items-start">
                            <div>
                                <h1 class="text-3xl font-bold text-gray-900">📋 忘れ物掲示板</h1>
                                <p class="mt-2 text-gray-600">
                                    忘れ物・落とし物の情報を確認できます
                                </p>
                            </div>
                            <div class="flex gap-3">
                                <!-- 教師のみ表示：忘れ物投稿ボタン -->
                                <button id="create-lost-item-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors" onclick="showLostItemForm()">
                                    ➕ 忘れ物を投稿
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 忘れ物作成フォーム -->
                    <div id="lost-item-form" class="bg-white p-6 rounded-lg shadow-sm mb-6 hidden">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">忘れ物情報を投稿</h3>
                        <form id="new-lost-item-form">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">タイトル*</label>
                                    <input type="text" name="title" required class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="例：黒い水筒">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">カテゴリ</label>
                                    <select name="category" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">選択してください</option>
                                        <option value="文房具">文房具</option>
                                        <option value="教科書・参考書">教科書・参考書</option>
                                        <option value="衣類">衣類</option>
                                        <option value="水筒・お弁当箱">水筒・お弁当箱</option>
                                        <option value="体操着">体操着</option>
                                        <option value="上履き">上履き</option>
                                        <option value="傘">傘</option>
                                        <option value="鍵">鍵</option>
                                        <option value="その他">その他</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">詳細説明*</label>
                                <textarea name="description" required rows="3" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="落とし物の特徴や発見場所などを入力してください"></textarea>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">状態</label>
                                    <select name="status" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="found">発見</option>
                                        <option value="lost">紛失</option>
                                        <option value="claimed">受取済</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">発見場所</label>
                                    <input type="text" name="location_found" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="例：体育館">
                                </div>
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">連絡先情報</label>
                                <input type="text" name="contact_info" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="例：職員室まで、1年A組田中先生まで">
                            </div>
                            <div class="flex gap-2">
                                <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 transition-colors">
                                    投稿
                                </button>
                                <button type="button" onclick="hideLostItemForm()" class="bg-gray-500 text-white px-6 py-2 rounded-md hover:bg-gray-600 transition-colors">
                                    キャンセル
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- 忘れ物一覧 -->
                    <div class="bg-white rounded-lg shadow-sm">
                        <div class="p-6">
                            <h2 class="text-xl font-semibold text-gray-900 mb-4">忘れ物一覧</h2>
                            <div id="lost-items-list" class="space-y-4">
                                <div class="text-center py-8 text-gray-500">
                                    <p>忘れ物の情報を読み込んでいます...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- クラス作成モーダル -->
    <div id="create-stream-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4">新しいクラス・ストリームを作成</h3>
                <form id="create-stream-form">
                    <div class="space-y-4">
                        <div>
                            <label for="stream-name" class="block text-sm font-medium text-gray-700">ストリーム名</label>
                            <input type="text" id="stream-name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="stream-description" class="block text-sm font-medium text-gray-700">説明</label>
                            <textarea id="stream-description" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                        </div>
                        <div>
                            <label for="stream-type" class="block text-sm font-medium text-gray-700">種類</label>
                            <select id="stream-type" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="class">クラス</option>
                                <option value="subject">教科</option>
                                <option value="school">全校</option>
                            </select>
                        </div>
                        <div id="class-fields" class="space-y-4">
                            <div>
                                <label for="class-name" class="block text-sm font-medium text-gray-700">クラス名</label>
                                <input type="text" id="class-name" placeholder="例: 1年A組" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="grade" class="block text-sm font-medium text-gray-700">学年</label>
                                <select id="grade" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">選択してください</option>
                                    <option value="1">1年</option>
                                    <option value="2">2年</option>
                                    <option value="3">3年</option>
                                </select>
                            </div>
                        </div>
                        <div id="subject-fields" class="hidden">
                            <div>
                                <label for="subject-name" class="block text-sm font-medium text-gray-700">教科名</label>
                                <input type="text" id="subject-name" placeholder="例: 数学" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        <div>
                            <label class="flex items-center">
                                <input type="checkbox" id="allow-student-posts" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <span class="ml-2 text-sm text-gray-700">生徒の投稿を許可</span>
                            </label>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="hideCreateStreamModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                            キャンセル
                        </button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            作成
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ユーザー招待モーダル -->
    <div id="invite-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4">ユーザーをストリームに招待</h3>
                <form id="invite-form">
                    <div class="space-y-4">
                        <div>
                            <label for="invite-stream" class="block text-sm font-medium text-gray-700">招待先ストリーム</label>
                            <select id="invite-stream" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="">選択してください</option>
                            </select>
                        </div>
                        <div>
                            <label for="invite-email" class="block text-sm font-medium text-gray-700">招待するユーザーのメールアドレス</label>
                            <input type="email" id="invite-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="invite-role" class="block text-sm font-medium text-gray-700">ロール</label>
                            <select id="invite-role" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="student">学生</option>
                                <option value="stream_admin">ストリーム管理者</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="hideInviteModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                            キャンセル
                        </button>
                        <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                            招待
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ブレインストーミングモーダル -->
    <div id="brainstorm-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-4 mx-auto p-5 border w-full max-w-6xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <!-- ヘッダー -->
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h3 class="text-2xl font-bold text-gray-900">ブレインストーミング</h3>
                        <p class="text-sm text-gray-600" id="brainstorm-stream-name">選択されたストリーム</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="text-sm text-gray-600">
                            <span id="brainstorm-phase" class="font-semibold">準備中</span>
                            <span class="mx-2">|</span>
                            <span id="brainstorm-participants">0人参加</span>
                            <span class="mx-2">|</span>
                            <span id="brainstorm-ideas-count">0件のアイデア</span>
                        </div>
                        <button onclick="closeBrainstormModal()" class="text-gray-400 hover:text-gray-600">
                            <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- 教師用コントロールパネル -->
                <div id="brainstorm-admin-panel" class="mb-6 bg-gray-50 rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <button id="brainstorm-start-btn" onclick="startBrainstormPhase('open')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                アイデア投稿開始
                            </button>
                            <button id="brainstorm-voting-btn" onclick="startBrainstormPhase('voting')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50" disabled>
                                投票開始
                            </button>
                            <button id="brainstorm-end-btn" onclick="endBrainstormSession()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:opacity-50" disabled>
                                セッション終了
                            </button>
                            <button id="brainstorm-delete-btn" onclick="deleteBrainstormSession()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                                削除
                            </button>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="createGroup()" class="px-3 py-1 bg-purple-600 text-white text-sm rounded hover:bg-purple-700">
                                + グループ作成
                            </button>
                            <button id="save-summary-btn" onclick="saveBrainstormSummary()" class="px-3 py-1 bg-indigo-600 text-white text-sm rounded hover:bg-indigo-700" disabled>
                                結果保存
                            </button>
                        </div>
                    </div>
                </div>

                <!-- メインコンテンツエリア -->
                <div class="flex gap-6 h-96">
                    <!-- アイデア投稿エリア -->
                    <div class="w-1/2 flex flex-col">
                        <h4 class="font-semibold text-gray-900 mb-3">アイデア投稿</h4>
                        
                        <!-- 投稿フォーム（生徒用） -->
                        <div id="brainstorm-input-area" class="mb-4">
                            <div class="flex gap-2">
                                <input type="text" id="brainstorm-idea-input" placeholder="アイデアを入力してください（最大50文字）" maxlength="50" 
                                    class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                                <button onclick="submitIdea()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                                    投稿
                                </button>
                            </div>
                            <div class="mt-2 text-xs text-gray-500">
                                <span id="brainstorm-rate-limit">あと3回投稿可能（30秒でリセット）</span>
                                <span class="mx-2">|</span>
                                <span id="brainstorm-remaining-votes" class="hidden">残り投票数: 3票</span>
                            </div>
                        </div>

                        <!-- アイデア一覧 -->
                        <div class="flex-1 bg-gray-50 rounded-lg p-4 overflow-y-auto">
                            <div id="brainstorm-ideas-list" class="space-y-2">
                                <div class="text-center text-gray-500 py-8">
                                    まだアイデアが投稿されていません
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- グループ化エリア -->
                    <div class="w-1/2 flex flex-col">
                        <h4 class="font-semibold text-gray-900 mb-3">グループ化・投票</h4>
                        
                        <div class="flex-1 bg-gray-50 rounded-lg p-4 overflow-y-auto">
                            <div id="brainstorm-groups-list" class="space-y-4">
                                <div class="text-center text-gray-500 py-8">
                                    グループを作成してアイデアをドラッグしてください
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 結果表示エリア -->
                <div id="brainstorm-results" class="hidden mt-6 bg-blue-50 rounded-lg p-4">
                    <h4 class="font-semibold text-gray-900 mb-3">ブレインストーミング結果</h4>
                    <div id="brainstorm-summary" class="text-sm text-gray-700">
                        <!-- 結果がここに表示されます -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
</body>
</html>